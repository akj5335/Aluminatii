<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alumni Directory | Aluminati</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Outfit', 'sans-serif'], heading: ['Poppins', 'sans-serif'] },
          colors: { primary: '#4F46E5', secondary: '#06B6D4', accent: '#F43F5E', dark: '#0F172A', 'dark-lighter': '#1E293B' }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="api.js"></script>
</head>

<body class="bg-slate-50 dark:bg-dark text-slate-800 dark:text-slate-200 antialiased">

  <!-- Navbar injected by script.js -->

  <main class="min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

    <div class="mb-10 fade-in">
      <h1 class="text-3xl font-heading font-bold text-slate-900 dark:text-white mb-6">Alumni Directory</h1>

      <!-- AI Recommendations -->
      <div id="ai-recommendations" class="mb-12 hidden">
        <div class="flex items-center gap-2 mb-4">
          <i class="fa-solid fa-wand-magic-sparkles text-amber-500"></i>
          <h2 class="text-xl font-bold text-slate-900 dark:text-white">Recommended for You</h2>
        </div>
        <div id="recommendations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Dynamic Content -->
        </div>
      </div>

      <!-- Search Bar -->
      <div class="relative max-w-2xl">
        <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
        <input type="text" id="searchInput" placeholder="Search alumni by name, company, or batch..."
          class="w-full pl-12 pr-4 py-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:ring-2 focus:ring-primary outline-none transition-all">
      </div>
    </div>

    <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">All Alumni</h2>
    <div id="directory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Loading Skeleton -->
      <div class="glass-card p-6 rounded-2xl animate-pulse">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
          <div class="space-y-2">
            <div class="w-24 h-4 bg-slate-200 dark:bg-slate-700 rounded"></div>
            <div class="w-16 h-3 bg-slate-200 dark:bg-slate-700 rounded"></div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="script.js"></script>
  <script>
    let allProfiles = [];

    async function loadDirectory() {
      const grid = document.getElementById('directory-grid');
      const recGrid = document.getElementById('recommendations-grid');

      try {
        // Load Recommendations
        try {
          const recs = await apiFetch('/api/connections/recommendations'); // Assuming this route exists/will exist
          if (recs && recs.length > 0) {
            document.getElementById('ai-recommendations').classList.remove('hidden');
            recs.forEach(rec => renderRecommendation(rec, recGrid));
          }
        } catch (e) {
          console.log("Recs failed (might not be implemented backend yet):", e);
        }

        const profiles = await apiFetch('/profiles'); // Using proper endpoint now
        // Fallback if profiles is object? No, implemented it to return { profiles: [] }
        const list = profiles.profiles || profiles;
        allProfiles = list;
        renderProfiles(list);

      } catch (err) {
        console.error(err);
      }
    }

    function renderRecommendation(rec, container) {
      const u = rec.user; // Depends on backend structure. Assuming it returns profile obj with score info? 
      // Or if it returns just profile, we render standard card but with "Why".
      // Let's assume standard profile object + 'matchReason' if possible, or just standard.
      // Actually, backend plan said "Return top 5 users".
      if (!u) return;

      const photo = u.photoURL || `https://ui-avatars.com/api/?name=${u.name}`;
      const html = `
        <div class="glass-card rounded-2xl p-6 border-2 border-amber-100 dark:border-amber-900/30 bg-amber-50/50 dark:bg-amber-900/10 hover:border-amber-300 transition-all">
             <div class="flex items-center gap-4 mb-3">
                <img src="${photo}" class="w-12 h-12 rounded-full object-cover">
                <div>
                    <h3 class="font-bold text-slate-900 dark:text-white leading-tight">${u.name}</h3>
                    <div class="text-xs font-semibold text-amber-600 dark:text-amber-400"><i class="fa-solid fa-star"></i> Top Match</div>
                </div>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${rec.designation || 'Alumni'} at ${rec.company || 'N/A'}</p>
            
            <div class="text-xs text-slate-500 mb-4 bg-white dark:bg-slate-800 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                <i class="fa-solid fa-circle-info text-primary"></i> ${rec.matchReason || 'Matches your profile'}
            </div>

            <a href="profile.html?id=${u._id}" class="block w-full py-2 rounded-lg bg-primary text-white text-center text-sm font-semibold hover:opacity-90 transition-colors"> Connect </a>
        </div>
        `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function renderProfiles(profiles) {
      const grid = document.getElementById('directory-grid');
      grid.innerHTML = '';

      if (profiles.length === 0) {
        grid.innerHTML = '<p class="text-slate-500">No alumni found.</p>';
        return;
      }

      profiles.forEach(profile => {
        if (!profile.user) return;
        const photo = profile.user.photoURL || `https://ui-avatars.com/api/?name=${profile.user.name}`;

        const card = `
                <div class="glass-card rounded-2xl p-6 border border-white/50 dark:border-slate-700 hover:border-primary/30 transition-all dark:bg-slate-800">
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${photo}" class="w-14 h-14 rounded-full object-cover bg-slate-100">
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white leading-tight">${profile.user.name}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${profile.designation || 'Alumni'}</p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-slate-600 dark:text-slate-400 mb-4">
                        <p><i class="fa-solid fa-briefcase w-5 text-slate-400"></i> ${profile.company || 'Not specified'}</p>
                        <p><i class="fa-solid fa-graduation-cap w-5 text-slate-400"></i> Class of ${profile.graduationYear || '20xx'}</p>
                    </div>
                    <a href="mailto:${profile.user.email}" class="block w-full py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-center text-sm font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        Connect
                    </a>
                </div>
                `;
        grid.insertAdjacentHTML('beforeend', card);
      });
    }

    // Search Filter
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allProfiles.filter(p => {
        return (p.user?.name.toLowerCase().includes(term) ||
          p.company?.toLowerCase().includes(term) ||
          p.designation?.toLowerCase().includes(term));
      });
      renderProfiles(filtered);
    });

    document.addEventListener('DOMContentLoaded', loadDirectory);
  </script>
</body>

</html>